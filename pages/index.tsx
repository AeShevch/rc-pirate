import Head from "next/head";
import styles from "@/styles/Home.module.css";
import { Card, Space, Alert, Form, Input, Button } from "antd";
import { useState } from "react";
import { ParserResponsePayload } from "@/pages/api/parser";
import axios from "axios";

export type ParserFormFields = {
  url: string;
  containerSelector: string;
};

export default function Home() {
  const [form] = Form.useForm<ParserFormFields>();
  const [isLoading, setIsLoading] = useState<boolean>(false);
  const [errorMessage, setErrorMessage] = useState<string | null>(null);
  const [successMessage, setSuccessMessage] = useState<string | null>(null);
  const [parserResult, setParserResult] =
    useState<ParserResponsePayload | null>(null);

  const getRichContent = async ({
    url,
    containerSelector,
  }: ParserFormFields): Promise<ParserResponsePayload | void> => {
    try {
      const { data } = await axios.get<ParserResponsePayload>(
        `/api/parser?url=${url}&containerSelector=${containerSelector}`
      );

      return data;
    } catch (err) {
      if (axios.isAxiosError(err)) {
        setErrorMessage(err.message);
      } else {
        console.log("unexpected err: ", err);
        setErrorMessage(`ü¶ú –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞! –ü–æ–∑–≤–∞—Ç—å —Ä–∞–∑—Ä–∞–±–∞ –Ω–∞ –º–æ—Å—Ç–∏–∫!`);
      }
    }
  };

  const onSubmit = (formFields: ParserFormFields) => {
    setErrorMessage(null);
    setSuccessMessage(null);
    setParserResult(null);
    setIsLoading(true);

    getRichContent(formFields)
      .then((res) => {
        if (!res) return;

        if (res.err) {
          setErrorMessage(res.err);
          return;
        }

        setParserResult(res);

        setSuccessMessage(
          `ü¶ú –ü–æ–ø—É—Ç–Ω—ã–π –≤–µ—Ç–µ—Ä! –ê–±–æ—Ä–¥–∞–∂ –ø—Ä–æ—à—ë–ª —É—Å–ø–µ—à–Ω–æ! –ß—Ç–æ –¥–µ–ª–∞–µ–º —Å –ø–ª–µ–Ω–Ω–∏–∫–æ–º?`
        );
      })
      .finally(() => {
        setIsLoading(false);
      });
  };

  return (
    <>
      <Head>
        <title>üè¥‚Äç‚ò†Ô∏è Yo-ho-ho!</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <main className={styles.main}>
        <Card
          title="üè¥‚Äç‚ò†Ô∏è Rich Content Pirate v0.9.0-beta"
          style={{ width: "40rem" }}
        >
          <Form form={form} onFinish={onSubmit} layout="vertical">
            <Space direction="vertical" size={20} style={{ width: "100%" }}>
              <Alert
                message={
                  <>
                    ¬´–†–µ–∫–≤–∏–∑–∏—Ä–æ–≤–∞—Ç—å. –ú—ã —Ä–µ–∫–≤–∏–∑–∏—Ä—É–µ–º —ç—Ç–æ—Ç —Ä–∏—á –∫–æ–Ω—Ç–µ–Ω—Ç. –≠—Ç–æ –º–æ—Ä—Å–∫–æ–π
                    —Ç–µ—Ä–º–∏–Ω¬ª <br /> ‚Äì –î–∂–µ–∫ –í–æ—Ä–æ–±–µ–π
                  </>
                }
                type="info"
              />

              <div>
                <Form.Item
                  name="url"
                  label="–°—Å—ã–ª–∫–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å ¬´—Ä–µ–∫–≤–∏–∑–∏—Ä—É–µ–º—ã–º¬ª –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º"
                  hasFeedback
                  rules={[
                    { required: true },
                    { type: "url", warningOnly: true },
                    {
                      type: "string",
                      min: 6,
                    },
                  ]}
                >
                  <Input
                    disabled={isLoading}
                    placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, https://istyle.cz/macbook-pro-14-...-stribrny.html"
                  />
                </Form.Item>
                <Form.Item
                  name="containerSelector"
                  hasFeedback
                  label="html-c–µ–ª–µ–∫—Ç–æ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ c –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º (–ù–∞ istyle.cz —ç—Ç–æ –æ–±—ã—á–Ω–æ .block-static-block)"
                  initialValue=".block-static-block"
                  rules={[{ required: true }, { type: "string" }]}
                >
                  <Input disabled={isLoading} />
                </Form.Item>
              </div>

              {!!errorMessage && <Alert message={errorMessage} type="error" />}

              <Button type="primary" htmlType="submit" loading={isLoading}>
                  {isLoading ? `–ü—Ä–æ—Ü–µ—Å—Å –Ω–µ–±—ã—Å—Ç—Ä—ã–π...` : `‚õµ –ü–æ–¥–Ω—è—Ç—å –ø–∞—Ä—É—Å–∞!`}
              </Button>

              {(successMessage || parserResult) && (
                <Space direction="vertical">
                  {!!successMessage && (
                    <Alert message={successMessage} type="success" />
                  )}

                  {!!parserResult && (
                    <>
                      {parserResult.previewUrl && (
                        <a
                          rel="noreferrer"
                          href={parserResult.previewUrl}
                          target="_blank"
                          style={{ color: `#1677ff` }}
                        >
                          –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–µ–≤—å—é (–≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ)
                        </a>
                      )}
                      {parserResult.downloadUrl && (
                        <a
                          rel="noreferrer"
                          href={parserResult.downloadUrl}
                          style={{
                            color: `#1677ff`,
                            borderBottom: `1px dashed currentColor`,
                          }}
                          download
                          target="_blank"
                        >
                          –°–∫–∞—á–∞—Ç—å –∞—Ä—Ö–∏–≤
                        </a>
                      )}
                    </>
                  )}
                </Space>
              )}
            </Space>
          </Form>
        </Card>
      </main>
    </>
  );
}
